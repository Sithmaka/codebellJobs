<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projects â€¢ CodeBell EMS</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    .badge.success { background:#d1fae5; color:#065f46; padding:3px 8px; border-radius:5px; }
    .badge.warn { background:#fee2e2; color:#991b1b; padding:3px 8px; border-radius:5px; }
    .row-actions button { margin-right:5px; }
    .progress-bar {
      background:#e5e7eb; border-radius:8px; overflow:hidden; height:14px;
    }
    .progress-fill {
      background:#3b82f6; height:100%; text-align:center; color:#fff;
      font-size:11px; line-height:14px;
    }
    /* Modal */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:20px; border-radius:8px; width:500px; max-width:95%; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .modal-header h3 { margin:0; }
    .modal .btn { margin-top:10px; }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="brand">CodeBell EMS</div>
      <h2>Navigation</h2>
      <nav class="nav">
        <a id="nav-dashboard" href="./index.html">Dashboard</a>
        <a id="nav-employees" href="./employees.html">Employees</a>
        <a id="nav-projects" href="./projects.html" class="active">Projects</a>
        <a id="nav-allocation" href="./allocation.html">Project Allocation</a>
        <a id="nav-attendance" href="./attendance.html" class="active">Attendance</a>
        <a id="nav-collab" href="./collab.html">Team Collaboration</a>
        <a id="nav-reports" href="./reports.html">Reports</a>
        <a id="nav-attendance" href="./attendance-report.html" class="active">Attendance Report</a>
      </nav>
      <div class="footer-note">CodeBell Employee Management System</div>
    </aside>
    <main class="main">
      
<div class="header">
  <h1>Projects</h1>
  <div class="searchbar">
    <input id="search" placeholder="Search projects by name or client"/>
    <button id="openModalBtn" class="btn">+ Create Project</button>
  </div>
</div>

<div class="card">
  <table class="table" id="projTable">
    <thead>
      <tr>
        <th>Name</th><th>Client</th><th>Start</th><th>End</th>
        <th>Status</th><th>Members</th><th>Progress</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal for Create Project -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create Project</h3>
      <button id="closeModalBtn">&times;</button>
    </div>
    <form id="projForm" class="grid cols-2">
      <div><label>Name<input name="name" required/></label></div>
      <div><label>Client<input name="client" required/></label></div>
      <div><label>Budget (LKR)<input name="budget" type="number" min="0"/></label></div>
      <div><label>Progress %<input name="progress" type="number" min="0" max="100" value="0"/></label></div>
      <div><label>Start Date<input name="startDate" type="date" required/></label></div>
      <div><label>End Date<input name="endDate" type="date" required/></label></div>
      <div><label>Status
        <select name="status">
          <option>Planned</option>
          <option>In Progress</option>
          <option>Completed</option>
          <option>On Hold</option>
        </select>
      </label></div>
      <div class="col-span"><label>Description<textarea name="desc" rows="3"></textarea></label></div>
      <div class="col-span"><button class="btn" type="submit">Save Project</button></div>
    </form>
  </div>
</div>

<!-- Modal for Edit Project -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Project</h3>
      <button id="closeEditModal">&times;</button>
    </div>
    <form id="editForm" class="grid cols-2">
      <input type="hidden" id="editId"/>
      <div><label>Progress %<input id="editProgress" type="number" min="0" max="100" required/></label></div>
      <div><label>Status
        <select id="editStatus">
          <option>Planned</option>
          <option>In Progress</option>
          <option>Completed</option>
          <option>On Hold</option>
        </select>
      </label></div>
      <div class="col-span"><button class="btn" type="submit">Save Changes</button></div>
    </form>
  </div>
</div>

    </main>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAH-1mTgjdjhaXqxNOhCpHRLNQ7QblGZbQ",
  authDomain: "codebelljobportal.firebaseapp.com",
  projectId: "codebelljobportal",
  storageBucket: "codebelljobportal.appspot.com",
  messagingSenderId: "516533965908",
  appId: "1:516533965908:web:8919af19029a1ab11289c1",
  measurementId: "G-61HE815QSX"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tbody = document.querySelector('#projTable tbody');
const search = document.querySelector('#search');

// Load projects
async function load(){
  const projsSnap = await getDocs(collection(db, "projects"));
  const allocsSnap = await getDocs(collection(db, "allocations"));

  const projects = projsSnap.docs.map(d => ({id:d.id, ...d.data()}));
  const allocs = allocsSnap.docs.map(d => d.data());

  // Count members per project
  const memberCount = {};
  allocs.forEach(a => {
    if (!memberCount[a.projectId]) memberCount[a.projectId] = 0;
    memberCount[a.projectId]++;
  });

  const term = (search.value||'').toLowerCase();
  tbody.innerHTML = '';
  projects
    .filter(p => (p.name + p.client).toLowerCase().includes(term))
    .forEach(p=>{
      const tr = document.createElement('tr');
      const prog = p.progress || 0;
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.client}</td>
        <td>${p.startDate||''}</td>
        <td>${p.endDate||''}</td>
        <td><span class="badge ${p.status==='Completed'?'success':'warn'}">${p.status}</span></td>
        <td>${memberCount[p.id] || 0}</td>
        <td>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${prog}%;">${prog}%</div>
          </div>
        </td>
        <td class="row-actions">
          <button class="btn ghost" data-edit="${p.id}">Edit</button>
          <button class="btn danger" data-del="${p.id}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
}
search.addEventListener('input', load);
await load();

// Edit/Delete handlers
document.addEventListener('click', async (e)=>{
  if (e.target.dataset.del){
    if (confirm('Delete project?')){
      await deleteDoc(doc(db, "projects", e.target.dataset.del));
      await load();
    }
  } else if (e.target.dataset.edit){
    const id = e.target.dataset.edit;
    const snap = await getDoc(doc(db, "projects", id));
    if (snap.exists()){
      const p = snap.data();
      document.getElementById("editId").value = id;
      document.getElementById("editProgress").value = p.progress || 0;
      document.getElementById("editStatus").value = p.status || "Planned";
      document.getElementById("editModal").style.display = "flex";
    }
  }
});

// Save edit
document.getElementById("editForm").addEventListener("submit", async (ev)=>{
  ev.preventDefault();
  const id = document.getElementById("editId").value;
  const progress = Number(document.getElementById("editProgress").value);
  const status = document.getElementById("editStatus").value;
  await updateDoc(doc(db, "projects", id), { progress, status });
  document.getElementById("editModal").style.display = "none";
  await load();
});

// Close edit modal
document.getElementById("closeEditModal").onclick = ()=> document.getElementById("editModal").style.display="none";
window.onclick = (e)=>{ 
  if (e.target==document.getElementById("projectModal")) document.getElementById("projectModal").style.display="none";
  if (e.target==document.getElementById("editModal")) document.getElementById("editModal").style.display="none";
}

// Modal open/close for create
const modal = document.getElementById("projectModal");
document.getElementById("openModalBtn").onclick = ()=> modal.style.display="flex";
document.getElementById("closeModalBtn").onclick = ()=> modal.style.display="none";

// Create project
document.querySelector('#projForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const fd = new FormData(ev.target);
  await addDoc(collection(db, "projects"), {
    name: fd.get('name'),
    client: fd.get('client'),
    budget: Number(fd.get('budget'))||0,
    progress: Number(fd.get('progress'))||0,
    startDate: fd.get('startDate'),
    endDate: fd.get('endDate'),
    status: fd.get('status'),
    description: fd.get('desc') || ''
  });
  ev.target.reset();
  modal.style.display="none";
  await load();
});
</script>

</body>
</html>